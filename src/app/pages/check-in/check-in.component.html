<mat-tab-group (selectedTabChange)="getTab($event.index)">
  <mat-tab label="รายงานเวลาเข้าประตู">
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-6">
          <button
            type="button"
            class="btn btn-primary"
            data-toggle="modal"
            data-target="#exampleModal"
            (click)="getUser()"
            style="margin: 10px"
          >
            เพิ่มการลา
          </button>
        </div>

        <!-- <div class="col-lg-3">
          <mat-form-field>
            <mat-label>Select TIME</mat-label>
            <mat-select
              [(ngModel)]="typeDevice"
              (ngModelChange)="doSomething(); inputT.value = ''"
            >
              <mat-option value="in">เวลาเข้างาน</mat-option>
              <mat-option value="out">เวลาออกงาน</mat-option>
            </mat-select>
          </mat-form-field>
        </div> -->
        <div class="col-lg-6" style="margin-top: 15px">
          <form [formGroup]="campaignOne" style="float: right">
            <mat-form-field
              style="margin-right: 10px"
              class="example-form-field"
              [style.width.px]="200"
            >
              <mat-date-range-input
                [formGroup]="campaignOne"
                [rangePicker]="campaignOnePicker"
              >
                <input
                  matStartDate
                  placeholder="Start date"
                  formControlName="start"
                />
                <input
                  matEndDate
                  placeholder="End date"
                  formControlName="end"
                  (dateChange)="startChange($event); inputT.value = ''"
                />
              </mat-date-range-input>
              <mat-datepicker-toggle
                matSuffix
                [for]="campaignOnePicker"
              ></mat-datepicker-toggle>
              <mat-date-range-picker #campaignOnePicker></mat-date-range-picker>
            </mat-form-field>

            <mat-form-field class="example-full-width">
              <input matInput (keyup)="applyFilter($event)" #inputT />
              <mat-placeholder>ค้นหา</mat-placeholder>
              <mat-icon matSuffix style="font-size: 1.2em">search</mat-icon>
            </mat-form-field>
          </form>
        </div>
      </div>

      <div class="responsive-table" [hidden]="!dataDrug.length">
        <section class="example-container mat-elevation-z8" tabindex="0">
          <table
            mat-table
            matTableExporter
            [dataSource]="dataSource"
            matSort
            #MatSort="matSort"
            #exporter="matTableExporter"
            class="mat-elevation-z8"
            [hiddenColumns]="[8]"
          >
            <ng-container matColumnDef="USERID">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>USERID</th>
              <td
                mat-cell
                *matCellDef="let element"
                style="padding-left: 20px; padding-right: 20px"
              >
                {{ element.USERID }}
              </td>
            </ng-container>

            <ng-container matColumnDef="userName" sticky>
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
              <td
                mat-cell
                *matCellDef="let element"
                style="padding-left: 20px; padding-right: 20px"
              >
                {{ element.userName }}
              </td>
            </ng-container>

            <ng-container matColumnDef="datestamp">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
              <td
                mat-cell
                *matCellDef="let element"
                style="padding-left: 20px; padding-right: 20px"
              >
                {{ element.datestamp }}
              </td>
            </ng-container>

            <ng-container matColumnDef="check_in">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Check In
              </th>
              <td
                mat-cell
                *matCellDef="let element"
                style="padding-left: 20px; padding-right: 20px"
              >
                {{ element.check_in }}
              </td>
            </ng-container>

            <ng-container matColumnDef="check_out">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Check Out
              </th>
              <td
                mat-cell
                *matCellDef="let element"
                style="padding-left: 20px; padding-right: 20px"
              >
                {{ element.check_out }}
              </td>
            </ng-container>
            <ng-container matColumnDef="type_leave">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Leave Type
              </th>
              <td mat-cell *matCellDef="let element" style="padding: 0 20px">
                <ng-container *ngIf="element.isEditing; else viewTypeLeave">
                  <select class="form-control" [(ngModel)]="element.type_leave">
                    <option *ngFor="let item of typeleave" [value]="item">
                      {{ item }}
                    </option>
                  </select>
                </ng-container>
                <ng-template #viewTypeLeave>
                  {{ element.type_leave }}
                </ng-template>
              </td>
            </ng-container>
            <ng-container matColumnDef="leave_time">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Leave Time
              </th>
              <td mat-cell *matCellDef="let element" style="padding: 0 20px">
                <ng-container *ngIf="element.isEditing; else viewTypeLeave">
                  <select class="form-control" [(ngModel)]="element.leave_time">
                    <option *ngFor="let item of timeleave" [value]="item">
                      {{ item }}
                    </option>
                  </select>
                </ng-container>
                <ng-template #viewTypeLeave>
                  {{ element.leave_time }}
                </ng-template>
              </td>
            </ng-container>

            <ng-container matColumnDef="leave_note">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Leave Note
              </th>
              <td mat-cell *matCellDef="let element" style="padding: 0 20px">
                <ng-container *ngIf="element.isEditing; else viewLeaveNote">
                  <input
                    type="text"
                    class="form-control"
                    [(ngModel)]="element.leave_note"
                  />
                </ng-container>
                <ng-template #viewLeaveNote>
                  {{ element.leave_note }}
                </ng-template>
              </td>
            </ng-container>
            <ng-container matColumnDef="Action">
              <th mat-header-cell *matHeaderCellDef>Action</th>
              <td mat-cell *matCellDef="let element" style="padding: 0 20px">
                <!-- ถ้า isEditing = true แสดงปุ่มบันทึก -->
                <button
                  type="button"
                  class="btn"
                  [ngClass]="
                    element.isEditing
                      ? 'btn-primary btn-sm'
                      : 'btn-warning btn-sm'
                  "
                  (click)="toggleEdit(element)"
                >
                  {{ element.isEditing ? "บันทึก" : "แก้ไข" }}
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </section>
        <div>
          <button
            mat-raised-button
            color="primary"
            (click)="
              exporter.exportTable('xlsx', {
                fileName: nameExcel,
                sheet: 'sheet_name',
                Props: { Author: 'Talha' }
              })
            "
          >
            Excel
          </button>

          <mat-paginator
            style="float: right"
            #MatPaginator="matPaginator"
            [length]="10"
            [pageSize]="10"
            [pageSizeOptions]="[10, 50, 100]"
            showFirstLastButtons
          >
          </mat-paginator>
        </div>
      </div>
    </div>
  </mat-tab>
  <mat-tab label="รายงานความถี่การเข้างานแต่ละช่วงเวลา">
    <div class="container-fluid">
      <div>
        <mat-form-field>
          <input
            matInput
            [matDatepicker]="startPicker"
            placeholder="เริ่มต้นเดือน"
            [value]="startMonth"
            readonly
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="startPicker"
          ></mat-datepicker-toggle>
          <mat-datepicker
            #startPicker
            startView="year"
            (monthSelected)="chooseMonth($event, startPicker)"
            [startAt]="defaultYear"
          >
          </mat-datepicker>
        </mat-form-field>
        &nbsp;-&nbsp;
        <mat-form-field>
          <input
            matInput
            [matDatepicker]="endPicker"
            placeholder="สิ้นสุดเดือน"
            [value]="endMonth"
            readonly
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="endPicker"
          ></mat-datepicker-toggle>
          <mat-datepicker
            #endPicker
            startView="year"
            (monthSelected)="chooseMonth2($event, endPicker)"
            [startAt]="defaultYear"
          >
          </mat-datepicker>
        </mat-form-field>

        <button
          mat-raised-button
          color="primary"
          (click)="getDatafreq()"
          style="margin: 10px"
        >
          Get Date Range
        </button>
      </div>

      <table class="mat-elevation-z8">
        <!-- Header -->
        <thead>
          <tr>
            <th rowspan="2">ชื่อ</th>
            <th [attr.colspan]="leaveTypes.length">รวม</th>
            <th
              *ngFor="let m of months | slice : monthStart - 1 : monthEnd"
              [attr.colspan]="leaveTypes.length"
            >
              {{ m.name }}
            </th>
          </tr>
          <tr>
            <th class="text-nowrap" *ngFor="let t of leaveTypes">{{ t }}</th>
            <ng-container
              *ngFor="let m of months | slice : monthStart - 1 : monthEnd"
            >
              <th class="text-nowrap" *ngFor="let t of leaveTypes">{{ t }}</th>
            </ng-container>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let emp of dataSource2">
            <td class="text-nowrap">
              {{ emp.fullName }}
            </td>

            <td
              *ngFor="let t of leaveTypes"
              (click)="onCellClick(emp, 'total', t, emp.total[t])"
              [ngClass]="{ 'hover-cell': true }"
            >
              {{ emp.total[t] }}
            </td>

            <ng-container
              *ngFor="let m of months | slice : monthStart - 1 : monthEnd"
            >
              <td
                *ngFor="let t of leaveTypes"
                (click)="onCellClick(emp, m.value, t, emp.months[m.value][t])"
                [ngClass]="{ 'hover-cell': true }"
              >
                {{ emp.months[m.value][t] }}
              </td>
            </ng-container>
          </tr>
        </tbody>
      </table>
      <button mat-raised-button color="primary" (click)="exportToExcel()">
        Export Excel
      </button>
    </div>
  </mat-tab>
</mat-tab-group>
<!-- Modal -->
<div
  class="modal fade"
  id="exampleModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title" id="exampleModalLabel">จัดการการลา</h1>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div>
          <div class="container mt-3">
            <button class="btn btn-primary mb-3 mr-2" (click)="showOrAddRow()">
              Add Data
            </button>

            <table class="table table-bordered" *ngIf="tableRows.length > 0">
              <thead>
                <tr>
                  <th></th>
                  <th>ลำดับ</th>
                  <th>ชื่อ-สกุล</th>
                  <th>วันที่ลา</th>
                  <th>ประเภทการลา</th>
                  <th>เวลาที่ลา</th>
                  <th>หมายเหตุ</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of tableRows; let i = index">
                  <td class="text-center">
                    <button
                      mat-icon-button
                      color="warn"
                      (click)="tableRows.splice(i, 1)"
                    >
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                  <td>{{ i + 1 }}</td>
                  <td>
                    <mat-form-field class="bootstrap-size" appearance="outline">
                      <mat-label>เลือก user</mat-label>
                      <input
                        type="text"
                        matInput
                        [formControl]="row.control"
                        [matAutocomplete]="auto"
                        placeholder="เลือก user"
                      />
                      <mat-autocomplete
                        #auto="matAutocomplete"
                        [displayWith]="displayFn"
                      >
                        <mat-option
                          *ngFor="let user of row.filtered$ | async"
                          [value]="user"
                        >
                          {{ user.userName }}
                        </mat-option>
                      </mat-autocomplete>
                    </mat-form-field>
                  </td>
                  <td>
                    <mat-form-field
                      class="bootstrap-size"
                      appearance="outline"
                      style="margin-right: 10px"
                      [style.width.px]="230"
                    >
                      <mat-date-range-input [rangePicker]="picker">
                        <input
                          matStartDate
                          placeholder="Start date"
                          [formControl]="row.leaveDateStart"
                        />
                        <input
                          matEndDate
                          placeholder="End date"
                          [formControl]="row.leaveDateEnd"
                        />
                      </mat-date-range-input>
                      <mat-datepicker-toggle
                        matSuffix
                        [for]="picker"
                      ></mat-datepicker-toggle>
                      <mat-date-range-picker #picker></mat-date-range-picker>

                      <!-- <mat-date-range-input [rangePicker]="campaignOnePicker2">
                        <input matStartDate placeholder="Start date" />
                        <input matEndDate placeholder="End date" />
                      </mat-date-range-input>
                      <mat-datepicker-toggle
                        matSuffix
                        [for]="campaignOnePicker2"
                      ></mat-datepicker-toggle>
                      <mat-date-range-picker
                        #campaignOnePicker2
                      ></mat-date-range-picker> -->
                    </mat-form-field>
                  </td>
                  <td>
                    <select class="form-control" [(ngModel)]="row.leaveType">
                      <option *ngFor="let item of typeleave" [value]="item">
                        {{ item }}
                      </option>
                    </select>
                  </td>
                  <td>
                    <select class="form-control" [(ngModel)]="row.leaveTime">
                      <option *ngFor="let item of timeleave" [value]="item">
                        {{ item }}
                      </option>
                    </select>
                  </td>
                  <td>
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="row.leaveNote"
                    />
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Close
        </button>
        <button type="button" class="btn btn-primary" (click)="getData2()">
          Save changes
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Modal -->
<div
  class="modal fade"
  id="leaveModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="leaveModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="leaveModalLabel">ตารางการลา</h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <table class="table table-bordered table-striped">
          <thead class="thead-dark">
            <tr>
              <th>#</th>

              <th>Full Name</th>
              <th>Leave Date</th>
              <th>Type</th>
              <th>Time</th>

              <th>Note</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of dataLeave; let i = index">
              <td>{{ i + 1 }}</td>

              <td>{{ item.FullName }}</td>
              <td>{{ item.leave_date }}</td>
              <td>{{ item.type_leave }}</td>
              <td>{{ item.leave_time }}</td>

              <td>{{ item.leave_note }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          ปิด
        </button>
      </div>
    </div>
  </div>
</div>
